# Sorting Network
Sorting network is a set of comparators and wires that are used for performing sorting on a fixed number of values. The network is designed for massive parallelization, therefore it is well suited for hardware implementation.
[Sorting Network](https://en.wikipedia.org/wiki/Sorting_network)

A typical diagram of a sorting network:
![alt text](draw/svg/sort_net_simple.drawio.svg)
On this figure, the unordered array of values enter on the left side. Each dot-pair represents a comparator (and swap). The network propagates it's values from left to right, at each comparator, the lower value goes to the upper wire ("float"), and the larger value goes to the bottom wire ("sink").

Example for better understanding:
![alt text](draw/svg/sort_net_simple_eg.drawio.svg)
On this figure, black numbers (0..3) represents the index of the wire, colors represents the values (4..7) and their path. The unordered array enters on the left side as `[7, 6, 4, 5]` , through comparisons and swaps, the ordered array exits the network on the right side as `[4, 5, 6, 7]`.

# Sorting Network Types
The most common sorting networks:
- Bitonic Sort ([Bitonic Sort](https://en.wikipedia.org/wiki/Bitonic_sorter))
- Batcher Odd-Even Mergesort ([Batcher Sort](https://en.wikipedia.org/wiki/Batcher_odd%E2%80%93even_mergesort))
- Pairwise Sorting Network ([Pairwise Sort](https://en.wikipedia.org/wiki/Pairwise_sorting_network))

Bitonic sort was invented first, but it requires more comparators than Batcher or Pairwise.
![alt text](draw/svg/sort_net_bitonic_batcher.drawio.svg)
The 4-input Bitonic sort uses 6 comparators, while the 4-input Batcher sort uses 5.

Batcher sort and Pairwise sort have very similar properties, but in my opinion Batcher sort has more clear structure.
# Generating Batcher Sort
This section is about my implementation of Batcher sorting network. The generated structure is identical to the original network, however the generation process might differ from it.
## Network Breakdown
A simple interactive Batcher sorting network generator can be found here: [Batcher Sort Interactive](https://bekbolatov.github.io/sorting/)
By changing the degree, some patterns can be recognized:
- The input count is degree^2
- The closely placed comparators create segments, where each comparator uses the same wire distance
- The *n*-th degree network uses the structures of lower degree networks

The terminology that I used:
- Degree: The magnitude of the network, primarily determines the network size
- Stage: Collection of nodes that are on the same depth
- Node: Single point in the network which performs an operation. This operation can be a comparison and swap, or data propagation
- Group: Group of nodes that are lower level Batcher sorting network
- Segment: Group of comparators that belongs to the same group and stage

Example of an 8-input Batcher sorting network:
![alt text](draw/svg/sort_net_batcher_term.drawio.svg)
On this figure:
- Blue lanes indicate the degree running index
- Yellow lanes indicate the stage running index inside a degree
- Dashed lines boxes are the groups
- White squares are the nodes with no comparison

## Python Code

With this structure, the following python code can be implemented to generate the network:
```python
net = []
for d in range(degree):                         # Degree
	for s in range(d + 1):                      # Stage
		for g in range(2 ** (degree - d - 1)):  # Group
			# Offset
			offset = 2 ** (d + 1) * g       # Start index of the group
			if s > 0:
				offset += 2 ** (d - s)      # Start index of the comparator in the stage
				
			# Count
			if s == 0:
				count = 1
			else:
				count = 2 ** s - 1

			# Size
			size = 2 ** (d - s)

			# Generate & add segment
			net.append(gen_cmps(offset, count, size))
```

Generate segments:
```python
# Generate segment
def gen_cmps(offset: int, count: int, size: int):
	cmps = []
	for i in range(count):
		for j in range(size):
			idx_low = offset + i * 2 * size + j
			idx_high = idx_low + size

			cmps.append((idx_low, idx_high))
			
	return cmps
```

Network generation order example of a 4-input network:
![alt text](draw/svg/sort_net_batcher_py.drawio.svg)
On this figure the number in the parenthesis indicate the degree-, stage-, group index respectively. Comparators with the same indices corresponds to the same comparator segment.

## Trimming
So far, the generator only produced network that has an input count which is power of 2, to be specific 2^Degree. Network that has a different input count can be generated by generating a full-size network and trimming excess nodes that are outside of the range.

Example trim of a 5-input network:
![alt text](draw/svg/sort_net_trim.drawio.svg)
The red lines are removed from the network.
## Merging Stages
In some cases the overall stage count can be reduced if the comparators are densely packed and moved to the front of the network.

Example merge of a 5-input network:
![alt text](draw/svg/sort_net_merge.drawio.svg)
